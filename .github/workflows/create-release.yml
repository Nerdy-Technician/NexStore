name: Create Release on Tag

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag version
        id: tag_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create release archive
        id: archive
        run: |
          VERSION=${{ steps.tag_version.outputs.version }}
          RELEASE_DIR="nerdystore-$VERSION"
          ARCHIVE_FILE="nerdystore-$VERSION.zip"
          
          mkdir -p "$RELEASE_DIR"
          cp -r nexterm/scripts "$RELEASE_DIR/" 2>/dev/null || true
          cp -r nexterm/snippets "$RELEASE_DIR/" 2>/dev/null || true
          cp README.md "$RELEASE_DIR/" 2>/dev/null || true
          
          zip -r "$ARCHIVE_FILE" "$RELEASE_DIR/"
          echo "archive=$ARCHIVE_FILE" >> $GITHUB_OUTPUT
          
          SCRIPTS=$(ls -1 nexterm/scripts/ 2>/dev/null | wc -l)
          SNIPPETS=$(ls -1 nexterm/snippets/ 2>/dev/null | wc -l)
          echo "scripts=$SCRIPTS" >> $GITHUB_OUTPUT
          echo "snippets=$SNIPPETS" >> $GITHUB_OUTPUT
          
          sha256sum "$ARCHIVE_FILE" > "$ARCHIVE_FILE.sha256"

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --list --sort=-v:refname | grep -v "^v${{ steps.tag_version.outputs.version }}$" | head -1)
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          PREV_TAG=${{ steps.prev_tag.outputs.prev_tag }}
          if [ -z "$PREV_TAG" ]; then
            CHANGELOG=$(git log --oneline | head -20)
          else
            CHANGELOG=$(git log "$PREV_TAG"..HEAD --oneline)
          fi
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.tag_version.outputs.version }}
          name: "NerdyStore Release v${{ steps.tag_version.outputs.version }}"
          body: |
            # NerdyStore Release v${{ steps.tag_version.outputs.version }}

            ## Contents
            - ðŸ“¦ **Scripts:** ${{ steps.archive.outputs.scripts }}
            - ðŸ”§ **Snippets:** ${{ steps.archive.outputs.snippets }}

            ## Recent Changes
            ```
            ${{ steps.changelog.outputs.changelog }}
            ```

            ## Installation
            ```bash
            unzip ${{ steps.archive.outputs.archive }}
            cd nerdystore-${{ steps.tag_version.outputs.version }}
            chmod +x nexterm/scripts/*.sh
            ```

            ## Verification
            ```bash
            sha256sum -c ${{ steps.archive.outputs.archive }}.sha256
            ```

            ---
            *Automatically generated by GitHub Actions*

          artifacts: "${{ steps.archive.outputs.archive }},${{ steps.archive.outputs.archive }}.sha256"
          artifactErrorsFailBuild: true
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
